<?php
/**
 * SmartCart API - Ingredient Prices for Meal Plan
 *
 * POST /api/ingredient-prices.php
 * Body: { "ingredients": ["яйца", "молоко", "сыр тёртый", ...] }
 *
 * Returns prices for each ingredient from the database
 */

require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../includes/database.php';
require_once __DIR__ . '/../includes/functions.php';

setCorsHeaders();

// Handle OPTIONS request
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    exit(0);
}

// Get input
$input = json_decode(file_get_contents('php://input'), true);
$ingredients = $input['ingredients'] ?? [];
$storeSlug = $input['store'] ?? 'perekrestok';

if (empty($ingredients)) {
    jsonResponse(['error' => 'No ingredients provided', 'results' => []]);
}

// Get store
$store = Database::query("SELECT id FROM stores WHERE slug = ?", [$storeSlug]);
if (empty($store)) {
    errorResponse('Store not found', 404);
}
$storeId = $store[0]['id'];

// Mapping rules for common ingredients
$ingredientMapping = [
    // Яйца
    'яйца' => ['terms' => ['Яйца С1', 'Яйца куриные С1', 'Яйца С0', 'Яйца куриные'], 'exclude' => ['перепел', 'порошок', 'лапша', 'майонез']],
    'яйцо' => ['terms' => ['Яйца С1', 'Яйца куриные С1', 'Яйца С0', 'Яйца куриные'], 'exclude' => ['перепел', 'порошок', 'лапша', 'майонез']],

    // Молочные
    'молоко' => ['terms' => ['Молоко 3,2', 'Молоко пастеризованное', 'Молоко 2,5'], 'exclude' => ['сгущ', 'сух', 'кокос', 'соевое', 'овсяное', 'миндальное', 'топлён']],
    'сыр тёртый' => ['terms' => ['Сыр тёртый', 'Сыр Пармезан тёртый', 'Сыр Российский'], 'exclude' => ['плавлен', 'творож']],
    'сыр' => ['terms' => ['Сыр Российский', 'Сыр Голландский', 'Сыр полутвёрдый'], 'exclude' => ['плавлен', 'творож', 'тёртый']],
    'сыр фета' => ['terms' => ['Сыр Фета', 'Фета', 'Брынза'], 'exclude' => []],
    'творог 5-9%' => ['terms' => ['Творог 5%', 'Творог 9%', 'Творог мягкий'], 'exclude' => ['сырок', 'масса', 'запеканка']],
    'творог' => ['terms' => ['Творог 5%', 'Творог 9%', 'Творог мягкий'], 'exclude' => ['сырок', 'масса', 'запеканка']],
    'сметана' => ['terms' => ['Сметана 15%', 'Сметана 20%', 'Сметана'], 'exclude' => ['соус']],
    'сливки 10-20%' => ['terms' => ['Сливки 10%', 'Сливки 20%', 'Сливки для соуса'], 'exclude' => ['взбит', 'раститель']],
    'сливки' => ['terms' => ['Сливки 10%', 'Сливки 20%', 'Сливки для соуса'], 'exclude' => ['взбит', 'раститель']],
    'масло сливочное' => ['terms' => ['Масло сливочное', 'Масло крестьянское'], 'exclude' => ['спред', 'маргарин']],
    'кокосовое молоко' => ['terms' => ['Кокосовое молоко', 'Молоко кокосовое'], 'exclude' => []],

    // Мясо
    'куриное филе' => ['terms' => ['Филе куриное', 'Филе грудки', 'Грудка куриная'], 'exclude' => ['колбас', 'сосис', 'пельмен', 'фарш', 'индейк', 'ветчина', 'копчён']],
    'куриная грудка' => ['terms' => ['Филе куриное', 'Грудка куриная', 'Филе грудки'], 'exclude' => ['колбас', 'сосис', 'пельмен', 'фарш', 'индейк', 'ветчина', 'копчён']],
    'куриные бёдра' => ['terms' => ['Бедро куриное', 'Бёдра куриные', 'Окорочок'], 'exclude' => ['копчён', 'варён']],
    'филе индейки' => ['terms' => ['Филе индейки', 'Индейка филе'], 'exclude' => ['колбас', 'ветчина', 'копчён']],
    'бекон' => ['terms' => ['Бекон', 'Грудинка'], 'exclude' => ['соус', 'чипсы']],
    'ветчина' => ['terms' => ['Ветчина', 'Окорок варёный'], 'exclude' => []],

    // Рыба
    'филе лосося/тилапии' => ['terms' => ['Филе лосося', 'Филе тилапии', 'Лосось филе', 'Тилапия филе'], 'exclude' => ['копчён', 'солён']],
    'филе тилапии/пангасиуса' => ['terms' => ['Филе тилапии', 'Филе пангасиуса', 'Тилапия', 'Пангасиус'], 'exclude' => ['копчён', 'панирован']],
    'тунец консервированный' => ['terms' => ['Тунец консервы', 'Тунец в собственном соку', 'Тунец'], 'exclude' => ['стейк', 'свежий']],

    // Крупы
    'рис отварной' => ['terms' => ['Рис длиннозёрный', 'Рис белый', 'Рис'], 'exclude' => ['бумага', 'уксус', 'лапша', 'молоко']],
    'рис' => ['terms' => ['Рис длиннозёрный', 'Рис белый', 'Рис шлифованный'], 'exclude' => ['бумага', 'уксус', 'лапша', 'молоко']],
    'рис для плова' => ['terms' => ['Рис для плова', 'Рис круглозёрный', 'Рис Девзира'], 'exclude' => []],
    'рис для суши' => ['terms' => ['Рис для суши', 'Рис круглозёрный'], 'exclude' => []],
    'гречка' => ['terms' => ['Гречка ядрица', 'Крупа гречневая'], 'exclude' => ['смесь', 'каша', 'хлопья', 'ассорти']],
    'овсяные хлопья' => ['terms' => ['Хлопья овсяные', 'Геркулес', 'Овсянка'], 'exclude' => ['печенье', 'батончик', 'каша готов', 'мюсли']],
    'макароны' => ['terms' => ['Макароны', 'Спагетти', 'Паста', 'Пенне'], 'exclude' => ['соус', 'готов']],
    'лапша удон' => ['terms' => ['Лапша удон', 'Удон'], 'exclude' => ['соус', 'готов']],
    'мука' => ['terms' => ['Мука пшеничная', 'Мука высший сорт'], 'exclude' => ['смесь', 'блин']],

    // Овощи
    'лук' => ['terms' => ['Лук репчатый', 'Лук жёлтый'], 'exclude' => ['сушен', 'маринован', 'чипсы', 'кольца', 'зелёный']],
    'морковь' => ['terms' => ['Морковь мытая', 'Морковь свежая', 'Морковь'], 'exclude' => ['сок', 'по-корейски', 'соус']],
    'морковь по-корейски' => ['terms' => ['Морковь по-корейски', 'Морковь корейская'], 'exclude' => []],
    'картофель' => ['terms' => ['Картофель мытый', 'Картофель', 'Картошка'], 'exclude' => ['чипсы', 'пюре', 'замороженн', 'фри']],
    'картошка' => ['terms' => ['Картофель мытый', 'Картофель', 'Картошка'], 'exclude' => ['чипсы', 'пюре', 'замороженн', 'фри']],
    'огурец' => ['terms' => ['Огурцы', 'Огурец свежий'], 'exclude' => ['маринован', 'солён', 'малосол', 'консерв']],
    'огурцы' => ['terms' => ['Огурцы', 'Огурец свежий'], 'exclude' => ['маринован', 'солён', 'малосол', 'консерв']],
    'огурец свежий' => ['terms' => ['Огурцы', 'Огурец свежий'], 'exclude' => ['маринован', 'солён', 'малосол', 'консерв']],
    'помидор' => ['terms' => ['Помидоры', 'Томаты'], 'exclude' => ['паста', 'соус', 'кетчуп', 'сушен', 'вялен', 'консерв', 'черри']],
    'помидоры' => ['terms' => ['Помидоры', 'Томаты'], 'exclude' => ['паста', 'соус', 'кетчуп', 'сушен', 'вялен', 'консерв']],
    'перец болгарский' => ['terms' => ['Перец болгарский', 'Перец сладкий', 'Перец красный'], 'exclude' => ['молотый', 'сушён', 'приправа']],
    'капуста белокочанная' => ['terms' => ['Капуста белокочанная', 'Капуста свежая'], 'exclude' => ['квашен', 'маринован', 'салат']],
    'капуста пекинская' => ['terms' => ['Капуста пекинская', 'Пекинская капуста'], 'exclude' => ['салат']],
    'капуста краснокочанная' => ['terms' => ['Капуста краснокочанная', 'Капуста красная'], 'exclude' => ['маринован']],
    'авокадо' => ['terms' => ['Авокадо'], 'exclude' => ['соус', 'масло']],
    'листья салата' => ['terms' => ['Салат листовой', 'Салат Айсберг', 'Салат Романо'], 'exclude' => ['готов', 'заправ']],
    'чеснок' => ['terms' => ['Чеснок', 'Чеснок свежий'], 'exclude' => ['сушён', 'гранул', 'порошок', 'соус']],
    'лук красный' => ['terms' => ['Лук красный', 'Лук репчатый красный'], 'exclude' => ['маринован']],
    'зелёный лук' => ['terms' => ['Лук зелёный', 'Зелёный лук'], 'exclude' => ['сушён']],

    // Фрукты
    'банан' => ['terms' => ['Бананы', 'Банан'], 'exclude' => ['чипсы', 'сушён']],
    'яблоко' => ['terms' => ['Яблоки', 'Яблоко'], 'exclude' => ['сок', 'пюре', 'сушен', 'чипсы', 'уксус']],
    'яблоко кислое' => ['terms' => ['Яблоки Гренни', 'Яблоки Симиренко', 'Яблоки зелёные'], 'exclude' => ['сок', 'пюре']],
    'лимон' => ['terms' => ['Лимон', 'Лимоны'], 'exclude' => ['сок', 'кислота']],
    'ягоды' => ['terms' => ['Ягоды замороженные', 'Смесь ягод', 'Черника', 'Малина'], 'exclude' => []],

    // Соусы и приправы
    'соевый соус' => ['terms' => ['Соевый соус', 'Соус соевый'], 'exclude' => []],
    'соус терияки' => ['terms' => ['Соус терияки', 'Терияки'], 'exclude' => []],
    'майонез' => ['terms' => ['Майонез', 'Майонез Провансаль'], 'exclude' => ['соус']],
    'горчица' => ['terms' => ['Горчица', 'Горчица дижонская'], 'exclude' => ['семена', 'порошок']],
    'паста карри' => ['terms' => ['Паста карри', 'Карри паста'], 'exclude' => []],
    'рисовый уксус' => ['terms' => ['Уксус рисовый', 'Рисовый уксус'], 'exclude' => []],
    'кунжутное масло' => ['terms' => ['Масло кунжутное', 'Кунжутное масло'], 'exclude' => []],
    'оливковое масло' => ['terms' => ['Масло оливковое', 'Оливковое масло'], 'exclude' => ['спрей']],
    'масло растительное' => ['terms' => ['Масло подсолнечное', 'Масло растительное'], 'exclude' => []],
    'мёд' => ['terms' => ['Мёд', 'Мед натуральный'], 'exclude' => ['горчица', 'соус']],
    'сахар' => ['terms' => ['Сахар-песок', 'Сахар белый'], 'exclude' => ['заменитель', 'ванильный']],
    'шрирача' => ['terms' => ['Соус Шрирача', 'Шрирача'], 'exclude' => []],

    // Топпинги
    'кунжут' => ['terms' => ['Кунжут', 'Семена кунжута'], 'exclude' => ['масло', 'паста', 'халва']],
    'оливки' => ['terms' => ['Оливки', 'Маслины'], 'exclude' => ['масло']],
    'нори' => ['terms' => ['Нори', 'Водоросли нори'], 'exclude' => []],
    'семечки' => ['terms' => ['Семечки подсолнуха', 'Семена подсолнечника'], 'exclude' => ['халва', 'козинак']],
    'кукуруза консерв.' => ['terms' => ['Кукуруза консервированная', 'Кукуруза сладкая'], 'exclude' => ['попкорн']],

    // Хлеб
    'хлеб' => ['terms' => ['Хлеб', 'Батон'], 'exclude' => ['сухари', 'крошка']],
    'хлеб для тостов' => ['terms' => ['Хлеб тостовый', 'Хлеб для тостов', 'Хлеб сэндвичный'], 'exclude' => []],

    // Заморозка
    'гёдза/дамплинги замороженные' => ['terms' => ['Гёдза', 'Дамплинги', 'Пельмени японские'], 'exclude' => []],
];

// Normalize ingredient name for matching
function normalizeIngredient($name) {
    $name = mb_strtolower(trim($name));
    // Remove amounts and units
    $name = preg_replace('/\d+\s*(г|мл|шт|ст\.л\.|ч\.л\.|л|кг)\.?/u', '', $name);
    $name = preg_replace('/по вкусу/u', '', $name);
    $name = preg_replace('/немного/u', '', $name);
    $name = preg_replace('/щепотка/u', '', $name);
    $name = preg_replace('/для подачи/u', '', $name);
    $name = preg_replace('/для смазки/u', '', $name);
    $name = preg_replace('/спрей или/u', '', $name);
    $name = trim($name);
    return $name;
}

$results = [];
$found = 0;
$notFound = 0;
$missingList = [];

foreach ($ingredients as $rawIngredient) {
    $normalized = normalizeIngredient($rawIngredient);

    // Skip generic items
    if (in_array($normalized, ['соль', 'перец', 'соль, перец', 'специи', 'по вкусу', 'вода', ''])) {
        $results[$rawIngredient] = [
            'status' => 'skip',
            'reason' => 'Базовый ингредиент'
        ];
        continue;
    }

    // Find mapping
    $mapping = null;
    foreach ($ingredientMapping as $key => $value) {
        if (mb_strpos($normalized, $key) !== false || $key === $normalized) {
            $mapping = $value;
            break;
        }
    }

    // Default mapping if not found
    if (!$mapping) {
        $mapping = [
            'terms' => [$normalized, ucfirst($normalized)],
            'exclude' => ['соус', 'приправ', 'готов']
        ];
    }

    $bestMatch = null;
    $bestPrice = PHP_FLOAT_MAX;

    foreach ($mapping['terms'] as $term) {
        $sql = "SELECT store_product_name as name, price, weight, unit, original_price, discount_percent
                FROM prices
                WHERE store_id = ? AND is_available = 1
                AND store_product_name LIKE ?
                ORDER BY price ASC LIMIT 20";
        $params = [$storeId, '%' . $term . '%'];

        $matches = Database::query($sql, $params);

        foreach ($matches as $match) {
            // Check exclusions
            $excluded = false;
            foreach ($mapping['exclude'] as $excl) {
                if (mb_stripos($match['name'], $excl) !== false) {
                    $excluded = true;
                    break;
                }
            }

            if (!$excluded && $match['price'] < $bestPrice) {
                $bestPrice = $match['price'];
                $bestMatch = $match;
            }
        }
    }

    if ($bestMatch) {
        $found++;
        $results[$rawIngredient] = [
            'status' => 'found',
            'product' => $bestMatch['name'],
            'price' => (float)$bestMatch['price'],
            'original_price' => $bestMatch['original_price'] ? (float)$bestMatch['original_price'] : null,
            'discount' => $bestMatch['discount_percent'] ? (int)$bestMatch['discount_percent'] : null,
            'weight' => $bestMatch['weight'],
            'unit' => $bestMatch['unit']
        ];
    } else {
        $notFound++;
        $missingList[] = $normalized;
        $results[$rawIngredient] = [
            'status' => 'not_found',
            'search_terms' => $mapping['terms']
        ];
    }
}

jsonResponse([
    'store' => $storeSlug,
    'stats' => [
        'total' => count($ingredients),
        'found' => $found,
        'not_found' => $notFound,
        'skipped' => count($ingredients) - $found - $notFound
    ],
    'results' => $results,
    'missing_for_extension' => array_unique($missingList)
]);
